{% load static %}

<!-- Blog Detail Container -->
<div class="blog-detail-container">
    
    <!-- Back Button -->
    <button class="back-btn" onclick="backToGallery()">
        ‚Üê Quay l·∫°i
    </button>

    <!-- Blog Title -->
    <h1 class="blog-title">{{ blog.blog_title }}</h1>

    <!-- Blog Meta -->
    <div class="blog-meta">
        <div class="meta-item">
            üìÖ <span>{{ blog.update_date|date:"d/m/Y" }}</span>
        </div>
        {% if blog.location %}
        <div class="meta-item">
            üìç <span>{{ blog.location.location_name }}</span>
        </div>
        {% endif %}
        <div class="meta-item">
            üì∑ <span>{{ photos|length }} ·∫£nh</span>
        </div>
    </div>

    <!-- Image Slider -->
    {% if photos %}
    <div class="image-slider">
        <div class="slider-wrapper">
            <!-- Slides -->
            {% for photo in photos %}
            <div class="slide {% if forloop.first %}active{% endif %}">
                <img src="{{ photo.picture.url }}" alt="{{ blog.blog_title }} - ·∫¢nh {{ forloop.counter }}">
            </div>
            {% endfor %}

            <!-- Navigation Arrows -->
            {% if photos|length > 1 %}
            <button class="slider-arrow prev" aria-label="Previous slide">‚Äπ</button>
            <button class="slider-arrow next" aria-label="Next slide">‚Ä∫</button>

            <!-- Dots -->
            <div class="slider-dots">
                {% for photo in photos %}
                <span class="dot {% if forloop.first %}active{% endif %}" data-slide="{{ forloop.counter0 }}"></span>
                {% endfor %}
            </div>

            <!-- Counter -->
            <div class="image-counter">
                <span id="current-slide">1</span> / <span id="total-slides">{{ photos|length }}</span>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Blog Content (Markdown converted to HTML) -->
    <div class="blog-content">
        {{ blog.get_html_content|safe }}
    </div>

    <!-- Camera Info -->
    {% if blog.camera_info %}
    <div class="camera-info-box">
        <h4>üì∑ Th√¥ng tin m√°y ·∫£nh</h4>
        <p>{{ blog.camera_info }}</p>
    </div>
    {% endif %}

    <!-- Location Map -->
    {% if blog.location and blog.location.maps_url %}
    <div class="camera-info-box">
        <h4>üó∫Ô∏è V·ªã tr√≠</h4>
        <p>
            <a href="{{ blog.location.maps_url }}" target="_blank" rel="noopener noreferrer">
                {{ blog.location.location_name }} - Xem tr√™n Google Maps ‚Üí
            </a>
        </p>
    </div>
    {% endif %}

    <!-- Related Posts -->
    {% if related_blogs %}
    <div class="related-posts">
        <h3>B√†i vi·∫øt li√™n quan</h3>
        <div class="related-grid">
            {% for related in related_blogs %}
            <div class="related-card" onclick="loadBlogDetail({{ related.blog_id }})">
                {% with related.photo_set.first as first_photo %}
                    {% if first_photo %}
                    <img src="{{ first_photo.picture.url }}" alt="{{ related.blog_title }}">
                    {% else %}
                    <div style="width: 100%; height: 200px; background: #E8E3DB; display: flex; align-items: center; justify-content: center; color: #7A7571;">
                        Kh√¥ng c√≥ ·∫£nh
                    </div>
                    {% endif %}
                {% endwith %}
                <div class="related-card-content">
                    <div class="related-card-title">{{ related.blog_title }}</div>
                    <div class="related-card-meta">
                        <span>{{ related.update_date|date:"d/m/Y" }}</span>
                        {% if related.location %}
                        <span>‚Ä¢ {{ related.location.location_name }}</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

</div>

<!-- CRITICAL: Initialize slider only when this content loads -->
<script>
(function() {
    console.log('üé¨ Blog detail content loaded, initializing slider...');
    
    // Wait for images to load before initializing
    const images = document.querySelectorAll('.slide img');
    let loadedImages = 0;
    
    if (images.length === 0) {
        console.log('‚ö†Ô∏è No images found');
        return;
    }
    
    function checkAllImagesLoaded() {
        loadedImages++;
        console.log(`üì∏ Image loaded: ${loadedImages}/${images.length}`);
        
        if (loadedImages === images.length) {
            console.log('‚úÖ All images loaded, initializing slider...');
            setTimeout(function() {
                if (typeof window.initializeSlider === 'function') {
                    window.initializeSlider();
                } else {
                    console.error('‚ùå initializeSlider function not found!');
                }
            }, 200);
        }
    }
    
    images.forEach(function(img) {
        if (img.complete) {
            checkAllImagesLoaded();
        } else {
            img.addEventListener('load', checkAllImagesLoaded);
            img.addEventListener('error', function() {
                console.error('‚ùå Image failed to load:', img.src);
                checkAllImagesLoaded(); // Still count it as "loaded" to proceed
            });
        }
    });
})();
</script>